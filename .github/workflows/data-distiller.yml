name: fetch-open-food-weekly

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday
  workflow_dispatch:

jobs:
  distill:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install DuckDB
        run: |
          wget -q https://github.com/duckdb/duckdb/releases/download/v1.1.3/duckdb_cli-linux-amd64.zip
          unzip duckdb_cli-linux-amd64.zip
          sudo mv duckdb /usr/local/bin/
          duckdb --version

      - name: Fetch Data Stream & Process
        run: |
          # Create directory for artifacts
          mkdir -p public/data
          
          # Run DuckDB script
          # effectively: wget -qO- url | gunzip | duckdb ...
          # But DuckDB handles http/gz natively.
          duckdb < utils/distill.sql
          
      - name: Enhance Data with Palm Tags
        run: node scripts/tag_palm_oil.js products.json

      - name: Prepare Data for Conversion
        run: mv products.json public/data/products.json

      - name: Convert to NDJSON & Compress
        run: node scripts/convert_data.js

      - name: Finalize & Version
        run: |
          # Clean up source JSON to save space (NDJSON.gz is independent)
          rm public/data/products.json
          
          # Generate Version File (~50 Bytes)
          echo "{\"last_updated\": $(date +%s%3N)}" > public/data/version.json

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public/data
          destination_dir: data
          keep_files: true # Keep existing app files if deploying to same branch? 
          # Actually, usually main app is on gh-pages root. Data might need to be in /data.
          # Better to deploy as a release asset or to a separate branch 'data'?
          # For simplicity, let's assume we deploy to 'gh-pages' branch under 'data/' folder.
          commit_message: "Update food database"
